<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISCA-k - Imputation Algorithm</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .btn,
        .form-group input,
        .form-group select,
        nav button {
          font-family: 'Exo', sans-serif;
        }


        html {
            overflow-x: hidden;
            height: 100%;
        }

        body {
            font-family: 'Exo','Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #011136;
            height: 100%;
            position: relative;
            overflow-x: hidden;
        }

        body.home-page {
            overflow: hidden;
            height: 100vh;
        }

        /* Background image 
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxyYWRpYWxHcmFkaWVudCBpZD0iZzEiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjUzMzMiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjxyYWRpYWxHcmFkaWVudCBpZD0iZzIiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjhkMzMiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjxyYWRpYWxHcmFkaWVudCBpZD0iZzMiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMzMzc3ODgiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiBmaWxsPSIjMWExZjJlIi8+PC9zdmc+');
            background-size: cover;
            background-position: center;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
        }*/

        .container {
            position: relative;
            z-index: 1;
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 30px;
            right: 50px;
            z-index: 1000;
            display: flex;
            gap: 0;
            align-items: center;
            background: linear-gradient(to left, rgba(1, 17, 54, 0.95) 0%, rgba(1, 17, 54, 0.85) 70%, transparent 100%);
            padding: 5px 20px 5px 40px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        nav button {
            background: transparent;
            border: none;
            color: #ffffff;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s ease;
            position: relative;
            letter-spacing: 0.5px;
        }

        nav button::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
        }

        nav button:first-child::before {
            display: none;
        }

        nav button:hover {
            color: #ff6b4a;
        }

        nav button.active {
            color: #ff6b4a;
            font-weight: 500;
        }

        /* Pages */
        .page {
            display: none;
            min-height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            position: relative;
        }

        /* Home Page */
        #home {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            height: 100vh;
            padding-bottom: 15vh;
            padding-left: 80px;
            overflow: hidden;
        }

        .home-content {
            text-align: left;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none; 
            cursor: default;
        }

        .logo {
            font-size: 96px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -2px;
            cursor: default;
        }

        .logo-black {
            color: #ffffff;
        }

        .logo-red {
            color: #ff6b4a;
        }

        .subtitle {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
            max-width: 600px;
            cursor: default;
        }

        /* About Page */
        #about {
            padding-top: 120px;
            padding-bottom: 40px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .about-content h1 {
            margin-bottom: 20px;
            color: #ffffff;
        }

        .about-content p {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        /* Privacy Page */
        #privacy {
            padding-top: 120px;
            padding-bottom: 40px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .privacy-content {
            max-width: 1200px;
            margin: 0 auto;
            text-align: left;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .privacy-content h1 {
            margin-bottom: 20px;
            color: #ffffff;
        }

        .privacy-content p {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        .privacy-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 30px;
        }
        
        .privacy-section {
          background: rgba(255, 255, 255, 0.05);
          border-radius: 10px;
          padding: 20px;
          border: 1px solid rgba(255, 107, 74, 0.1);
        }
        
        .privacy-section strong {
          color: #ff6b4a;
          display: block;
          margin-bottom: 10px;
        }
        
        .privacy-section ul {
          list-style: none;
          margin: 0;
          padding: 0;
        }
        
        .privacy-section li {
          line-height: 1.6;
          color: rgba(255, 255, 255, 0.8);
          margin-bottom: 6px;
        }
        
        .privacy-section li::before {
          content: "• ";
          color: #ff6b4a;
          font-weight: bold;
        }

        /* Test Methods Page */
        #test-methods {
            padding-top: 120px;
            padding-bottom: 50px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .test-methods-content {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .test-methods-content h1 {
            margin-bottom: 10px;
            color: #ffffff;
            text-align: center;
        }

        .test-methods-content .subtitle-test {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .test-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .test-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .selection-card {
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 107, 74, 0.05);
        }

        .selection-card:hover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.15);
            transform: translateY(-3px);
        }

        .selection-card.selected {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.2);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.4);
        }

        .selection-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .selection-card.disabled:hover {
            transform: none;
            border-color: rgba(255, 107, 74, 0.3);
        }

        .selection-card h3 {
            color: #ffffff;
            margin-bottom: 8px;
            font-size: 18px;
        }

        .selection-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin: 0;
        }

        .selection-label {
            display: block;
            color: #ff6b4a;
            font-weight: 500;
            margin: 20px 0 10px 0;
            font-size: 16px;
        }

        .method-limit-warning {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
        }

        .results-container {
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background: rgba(255, 107, 74, 0.3);
            color: #ffffff;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            border: 1px solid rgba(255, 107, 74, 0.2);
        }

        .results-table td {
            padding: 10px;
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table .best-result {
            background: rgba(76, 175, 80, 0.2);
            font-weight: 600;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        /* Feedback Page */
        #feedback {
            padding-top: 120px;
            padding-bottom: 50px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .feedback-content {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .feedback-content h1 {
            margin-bottom: 10px;
            color: #ffffff;
            text-align: center;
        }

        .feedback-content .subtitle-feedback {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section label {
            display: block;
            color: #ff6b4a;
            font-weight: 500;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .form-section input[type="number"],
        .form-section input[type="email"],
        .form-section select,
        .form-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-family: 'Exo', sans-serif;
            font-size: 14px;
        }

        .form-section textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-section input:focus,
        .form-section select:focus,
        .form-section textarea:focus {
            outline: none;
            border-color: #ff6b4a;
            background: rgba(255, 255, 255, 0.08);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-group-feedback {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .radio-group-feedback label {
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 400;
            cursor: pointer;
        }

        .radio-group-feedback input[type="radio"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .dataset-shape-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .shape-input-wrapper label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .submit-section {
            text-align: center;
            margin-top: 30px;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Imputation Page */
        #imputation {
            padding-top: 120px;
            padding-bottom: 50px;
            min-height: 100vh;
            overflow-y: auto;
        }

        .imputation-content {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .imputation-content h1 {
            margin-bottom: 30px;
            color: #ffffff;
            text-align: center;
        }

        .imputation-content h2 {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed rgba(255, 107, 74, 0.4);
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(255, 107, 74, 0.05);
        }

        .upload-area:hover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.15);
        }

        .upload-area h3, .upload-area p {
            color: #ffffff;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #ff6b4a;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            margin: 10px 5px;
            font-family: 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .btn:hover {
            background: #ff8566;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
        }

        table th, table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            text-align: left;
            color: rgba(255, 255, 255, 0.9);
        }

        table th {
            background: rgba(255, 107, 74, 0.2);
            font-weight: 600;
            color: #ffffff;
        }

        table td em {
            color: #ff6b4a;
        }

        .method-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .method-card {
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 107, 74, 0.05);
        }

        .method-card:hover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 107, 74, 0.3);
        }

        .method-card.selected {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.2);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.4);
        }

        .method-card h3 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .method-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 5px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-family: 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b4a;
            background: rgba(255, 255, 255, 0.08);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .progress-container {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ff6b4a;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b4a, #ff8566);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .info-box {
            background: rgba(255, 107, 74, 0.1);
            border-left: 4px solid #ff6b4a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .info-box strong {
            color: #ffffff;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .error-box {
            background: rgba(255, 82, 82, 0.1);
            border-left: 4px solid #ff5252;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-container {
            text-align: center;
            padding: 40px 20px;
        }

        .progress-container h2 {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .progress-container p {
            color: rgba(255, 255, 255, 0.8);
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .subtitle {
          font-size: 20px; /* tamanho base */
        }
        
        .subtitle .highlight {
          font-weight: bold;
          font-size: 1.3em; /* aumenta apenas as letras */
        }
    </style>
</head>
<body class="home-page">
    <nav>
        <button onclick="showPage('home')" class="nav-btn active" data-page="home">Home</button>
        <button onclick="showPage('about')" class="nav-btn" data-page="about">About</button>
        <button onclick="showPage('imputation')" class="nav-btn" data-page="imputation">Imputation</button>
        <button onclick="showPage('test-methods')" class="nav-btn" data-page="test-methods">Test Methods</button>
        <button onclick="showPage('feedback')" class="nav-btn" data-page="feedback">Feedback</button>
        <button onclick="showPage('privacy')" class="nav-btn" data-page="privacy">Data Privacy</button>
    </nav>

    <div class="container">
        <!-- HOME PAGE -->
        <div id="home" class="page active">
            <div class="home-content">
                <div class="logo">
                    <span class="logo-black">ISCA-</span><span class="logo-red">k</span>
                </div>
                <div class="subtitle">
                  <span class="highlight">I</span>mputation & 
                  <span class="highlight">S</span>imilarity-based 
                  <span class="highlight">C</span>lassification 
                  <span class="highlight">A</span>lgorithm 
                </div>
            </div>
        </div>

        <!-- ABOUT PAGE -->
        <div id="about" class="page">
            <div class="about-content">
                <h1>About ISCA-k</h1>
                
                <p><strong>ISCA-k</strong> is an advanced method for imputing (filling in) missing data. It enhances traditional k-Nearest Neighbors (KNN) approaches through three key innovations:</p>
                
                <p><strong>1. Intelligent Feature Weighting:</strong> The method first calculates Mutual Information (MI) between all variables. This identifies which features are most predictive for the variable with missing data. When calculating similarity, ISCA-k gives proportionally more weight to these highly predictive features and less to irrelevant ones.</p>
                
                <p><strong>2. Adaptive 'k' (Neighbors):</strong> Instead of using a fixed number of neighbors, ISCA-k uses an adaptive mechanism based on a "trust factor." If potential neighbors are very similar (distances are tightly clustered), the method uses more neighbors. If they are dissimilar (distances are widely dispersed), it uses fewer neighbors to avoid contamination from poor matches.</p>
                
                <p><strong>3. Mixed-Data Handling:</strong> The method effectively handles datasets containing both numeric and categorical variables. It uses type-specific normalization to ensure numeric variables don't dominate the similarity calculations simply because of differences in their scale.</p>

                <h2>Purpose of This Site</h2>
                
                <p>This website serves as a beta testing platform where you can test <strong>ISCA-k</strong> on your own datasets and provide valuable feedback. Your input is crucial for refining the method and identifying potential improvements before its final release.</p>
                
                <p>This work is part of my Master's thesis in Data Analysis and Decision Support Systems at ISCAC - Coimbra Business School. By participating in this beta test, you are directly contributing to academic research aimed at advancing missing data imputation techniques.</p>
                
                <p><strong>How to participate:</strong> Simply upload your dataset, configure the imputation parameters, and download your results. We strongly encourage you to share your experience and any issues you encounter through the feedback form.</p>
                
            </div>
        </div>

        <!-- IMPUTATION PAGE -->
        <div id="imputation" class="page">
            <div class="imputation-content">
                <h1>Dataset Imputation</h1>

                <!-- Step 1: Upload -->
                <div class="step active" id="step-upload">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <h3>📁 Upload your CSV dataset</h3>
                        <p>Click to select or drag and drop your file here</p>
                        <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <!-- Step 2: Preview -->
                <div class="step" id="step-preview">
                    <h2>Dataset Preview</h2>
                    <div id="missingInfo"></div>
                    <div id="previewTable"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="resetUpload()">Upload Different File</button>
                        <button class="btn" onclick="showStep('step-method')">Continue</button>
                    </div>
                </div>

                <!-- Step 3: Method Selection -->
                <div class="step" id="step-method">
                    <h2>Select Imputation Method</h2>
                    <div class="method-selection" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="method-card" onclick="selectMethod('iscak')">
                            <h3 style="color: #dc143c;">ISCA-k</h3>
                            <p>Information-theoretic Smart Collaborative Approach</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('knn')">
                            <h3>k-NN</h3>
                            <p>k-Nearest Neighbors imputation</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('mice')">
                            <h3>MICE</h3>
                            <p>Multiple Imputation by Chained Equations</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('missforest')">
                            <h3>MissForest</h3>
                            <p>Random Forest-based imputation</p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showStep('step-preview')">Back</button>
                    </div>
                </div>

                <!-- Step 4: Parameters -->
                <div class="step" id="step-params">
                    <h2>Configure Parameters</h2>
                    <div id="paramsForm"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showStep('step-method')">Back</button>
                        <button class="btn" onclick="startImputation()">Start Imputation</button>
                    </div>
                </div>

                <!-- Step 5: Processing -->
                <div class="step" id="step-processing">
                    <div class="progress-container">
                        <h2>Processing...</h2>
                        <div class="spinner"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <p id="progressText">Initializing...</p>
                    </div>
                </div>

                <!-- Step 6: Complete -->
                <div class="step" id="step-complete">
                    <div class="progress-container">
                        <h2>✓ Imputation Complete!</h2>
                        <div class="info-box">
                            <p><strong>Dataset successfully imputed!</strong></p>
                            <p id="completionInfo"></p>
                        </div>
                        <button class="btn" onclick="downloadImputedData()">Download Imputed Dataset</button>
                        <button class="btn btn-secondary" onclick="resetImputation()">Start New Imputation</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEST METHODS PAGE -->
        <div id="test-methods" class="page">
            <div class="test-methods-content">
                <h1>Test Methods Comparison</h1>
                <p class="subtitle-test">Compare imputation methods with controlled missing data patterns</p>

                <!-- Step 1: Dataset Selection -->
                <div class="test-step active" id="test-step-1">
                    <h2 style="color: #ff6b4a; margin-bottom: 20px;">Step 1: Select Dataset</h2>

                    <label class="selection-label">Dataset Type</label>
                    <div class="selection-grid">
                        <div class="selection-card selected" onclick="selectDatasetType('numeric')">
                            <h3>Pure Numeric</h3>
                            <p>1 dataset available</p>
                        </div>
                        <div class="selection-card disabled">
                            <h3>Mixed</h3>
                            <p>Coming soon</p>
                        </div>
                        <div class="selection-card disabled">
                            <h3>Categorical</h3>
                            <p>Coming soon</p>
                        </div>
                    </div>

                    <label class="selection-label">Choose Dataset</label>
                    <div class="selection-grid" id="dataset-options">
                        <div class="selection-card" onclick="selectDataset('iris')" data-dataset="iris">
                            <h3>IRIS</h3>
                            <p>150 rows × 4 cols</p>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button class="btn" onclick="goToTestStep(2)" id="btn-step-1">Continue</button>
                    </div>
                </div>

                <!-- Step 2: Methods Selection -->
                <div class="test-step" id="test-step-2">
                    <h2 style="color: #ff6b4a; margin-bottom: 20px;">Step 2: Select Methods to Compare</h2>

                    <div class="method-limit-warning">
                        ⚠️ Select 2 or 3 methods to compare
                    </div>

                    <label class="selection-label">Available Methods</label>
                    <div class="selection-grid">
                        <div class="selection-card" onclick="toggleMethod('iscak')" data-method="iscak">
                            <h3>ISCA-k</h3>
                            <p>Adaptive k-NN</p>
                        </div>
                        <div class="selection-card" onclick="toggleMethod('knn')" data-method="knn">
                            <h3>k-NN</h3>
                            <p>Standard k-NN</p>
                        </div>
                        <div class="selection-card" onclick="toggleMethod('mice')" data-method="mice">
                            <h3>MICE</h3>
                            <p>Iterative Imputation</p>
                        </div>
                        <div class="selection-card" onclick="toggleMethod('missforest')" data-method="missforest">
                            <h3>MissForest</h3>
                            <p>Random Forest</p>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="goToTestStep(1)">Back</button>
                        <button class="btn" onclick="goToTestStep(3)" id="btn-step-2" disabled>Continue</button>
                    </div>
                </div>

                <!-- Step 3: Test Configuration -->
                <div class="test-step" id="test-step-3">
                    <h2 style="color: #ff6b4a; margin-bottom: 20px;">Step 3: Configure Test</h2>

                    <label class="selection-label">Missing Rate</label>
                    <div class="selection-grid">
                        <div class="selection-card" onclick="selectMissingRate(10)" data-rate="10">
                            <h3>10%</h3>
                        </div>
                        <div class="selection-card" onclick="selectMissingRate(20)" data-rate="20">
                            <h3>20%</h3>
                        </div>
                        <div class="selection-card" onclick="selectMissingRate(30)" data-rate="30">
                            <h3>30%</h3>
                        </div>
                        <div class="selection-card" onclick="selectMissingRate(40)" data-rate="40">
                            <h3>40%</h3>
                        </div>
                    </div>

                    <div id="params-container" style="margin-top: 30px;"></div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="goToTestStep(2)">Back</button>
                        <button class="btn" onclick="startComparison()" id="btn-step-3" disabled>Start Comparison</button>
                    </div>
                </div>

                <!-- Step 4: Running Tests -->
                <div class="test-step" id="test-step-4">
                    <div class="progress-container">
                        <h2>Running Tests...</h2>
                        <div class="spinner"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="test-progress-fill">0%</div>
                        </div>
                        <p id="test-progress-text">Preparing...</p>
                    </div>
                </div>

                <!-- Step 5: Results -->
                <div class="test-step" id="test-step-5">
                    <h2 style="color: #ff6b4a; margin-bottom: 20px;">Results</h2>

                    <div class="info-box" id="test-summary"></div>

                    <div class="results-container">
                        <h3 style="color: #ffffff; margin-bottom: 15px;">Metrics Comparison</h3>
                        <div class="results-table" id="results-table-container"></div>

                        <h3 style="color: #ffffff; margin: 30px 0 15px 0;">NRMSE Comparison</h3>
                        <div class="chart-container">
                            <canvas id="nrmse-chart" width="800" height="400"></canvas>
                        </div>
                    </div>

                    <div class="button-group" style="margin-top: 30px;">
                        <button class="btn btn-secondary" onclick="resetTestMethods()">New Test</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- FEEDBACK PAGE -->
        <div id="feedback" class="page">
            <div class="feedback-content">
                <h1>Feedback Form</h1>
                <p class="subtitle-feedback">Your feedback is essential for improving ISCA-k. Please share your experience!</p>

                <div class="success-message" id="successMessage">
                    <strong>Thank you!</strong> Your feedback has been submitted successfully.
                </div>

                <form id="feedbackForm" action="https://formsubmit.co/vicentericardo0@gmail.com" method="POST">
                    <!-- Hidden fields for FormSubmit configuration -->
                    <input type="hidden" name="_subject" value="New ISCA-k Feedback Submission">
                    <input type="hidden" name="_captcha" value="false">
                    <input type="hidden" name="_template" value="table">

                    <!-- User Type -->
                    <div class="form-section">
                        <label>User Type *</label>
                        <select name="user_type" required>
                            <option value="">Select your profile...</option>
                            <option value="Student">Student</option>
                            <option value="Academic">Academic</option>
                            <option value="Professional">Professional</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <!-- Dataset Shape -->
                    <div class="form-section">
                        <label>Dataset Shape *</label>
                        <div class="dataset-shape-inputs">
                            <div class="shape-input-wrapper">
                                <label>Number of Rows</label>
                                <input type="number" name="dataset_rows" placeholder="e.g., 1000" min="1" required>
                            </div>
                            <div class="shape-input-wrapper">
                                <label>Number of Columns</label>
                                <input type="number" name="dataset_columns" placeholder="e.g., 10" min="1" required>
                            </div>
                        </div>
                    </div>

                    <!-- Methods Used -->
                    <div class="form-section">
                        <label>Methods Used * (select one or more)</label>
                        <div class="checkbox-group">
                            <label>
                                <input type="checkbox" name="method_iscak" value="ISCA-k">
                                ISCA-k
                            </label>
                            <label>
                                <input type="checkbox" name="method_knn" value="k-NN">
                                k-NN
                            </label>
                            <label>
                                <input type="checkbox" name="method_mice" value="MICE">
                                MICE
                            </label>
                            <label>
                                <input type="checkbox" name="method_missforest" value="MissForest">
                                MissForest
                            </label>
                        </div>
                    </div>

                    <!-- Dataset Type -->
                    <div class="form-section">
                        <label>Dataset Type *</label>
                        <div class="radio-group-feedback">
                            <label>
                                <input type="radio" name="dataset_type" value="Real" required>
                                Real Dataset
                            </label>
                            <label>
                                <input type="radio" name="dataset_type" value="Synthetic" required>
                                Synthetic Dataset
                            </label>
                        </div>
                    </div>

                    <!-- Feedback Text -->
                    <div class="form-section">
                        <label>Your Feedback *</label>
                        <textarea name="feedback_text" placeholder="Please share your experience, suggestions, or any issues you encountered..." required></textarea>
                    </div>

                    <!-- Email (optional) -->
                    <div class="form-section">
                        <label>Email (optional)</label>
                        <input type="email" name="email" placeholder="your.email@example.com">
                        <small style="color: rgba(255, 255, 255, 0.6); font-size: 12px; display: block; margin-top: 5px;">
                            Provide your email if you'd like us to follow up on your feedback
                        </small>
                    </div>

                    <!-- Submit Button -->
                    <div class="submit-section">
                        <button type="submit" class="btn">Submit Feedback</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="privacy" class="page">
          <div class="privacy-content">
            <h1>Privacy & Data Protection</h1>
        
            <div class="privacy-grid">
              <div class="privacy-section">
                <strong>LOCAL PROCESSING (k-NN, MICE, MissForest)</strong>
                <ul>
                  <li>All processing occurs locally, directly in your browser</li>
                  <li>Your data NEVER leaves your browser</li>
                  <li>100% client-side processing</li>
                  <li>Zero data transmission to servers</li>
                  <li>No storage, no tracking, no logs</li>
                </ul>
              </div>
        
              <div class="privacy-section">
                <strong>CLOUD PROCESSING (ISCA-k)</strong>
                <ul>
                  <li>Data temporarily sent to secure EU server (Render.com - Frankfurt)</li>
                  <li>Processed in-memory only (never written to disk)</li>
                  <li>Automatically deleted after response</li>
                  <li>HTTPS encrypted transmission</li>
                  <li>No permanent storage or data retention</li>
                  <li>Minimal metadata (timestamps, file sizes) may remain temporarily</li>
                  <li>We do NOT store, sell, or share your data</li>
                </ul>
              </div>
        
              <div class="privacy-section">
                <strong>SECURITY</strong>
                <ul>
                  <li>HTTPS/TLS encryption</li>
                  <li>No authentication = no user tracking</li>
                  <li>No cookies, no analytics</li>
                  <li>Open-source code (audit on GitHub)</li>
                </ul>
              </div>
        
              <div class="privacy-section">
                <strong>RECOMMENDATIONS</strong>
                <ul>
                  <li>Anonymize data before upload</li>
                  <li>Do not upload personal identifiable information (PII)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>


    </div>

    <script>
        let currentData = null;
        let originalData = null;
        let fileName = '';
        let selectedMethod = '';
        let missingCount = 0;
        let imputedData = null;
        
        // API URL - ALTERAR DEPOIS DO DEPLOY NO RENDER
        const API_URL = 'https://iscak-backend.onrender.com'; 

        // Navigation
        function showPage(pageName) {
            // Fade out current page
            const currentPage = document.querySelector('.page.active, .page-pri.active');
            if (currentPage) {
                currentPage.style.opacity = '0';
                setTimeout(() => {
                    currentPage.classList.remove('active');

                    // Fade in new page
                    const newPage = document.getElementById(pageName);
                    newPage.classList.add('active');
                    setTimeout(() => {
                        newPage.style.opacity = '1';
                    }, 50);
                }, 300);
            } else {
                document.getElementById(pageName).classList.add('active');
            }

            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

            // Toggle body overflow based on page
            if (pageName === 'home') {
                document.body.classList.add('home-page');
            } else {
                document.body.classList.remove('home-page');
            }

            // Reset imputation page when navigating to it
            if (pageName === 'imputation') {
                resetImputation();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        // File Upload
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                handleFile(file);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            fileName = file.name;
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    originalData = results.data;
                    currentData = JSON.parse(JSON.stringify(results.data));
                    analyzeAndShowPreview();
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function analyzeAndShowPreview() {
            // Count missing values
            missingCount = 0;
            currentData.forEach(row => {
                Object.values(row).forEach(val => {
                    if (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) {
                        missingCount++;
                    }
                });
            });

            const missingInfo = document.getElementById('missingInfo');
            
            if (missingCount === 0) {
                missingInfo.innerHTML = `
                    <div class="warning-box">
                        <p><strong>No missing values detected!</strong></p>
                        <p>Your dataset appears to be complete. Imputation is not necessary.</p>
                    </div>
                `;
                setTimeout(() => {
                    resetUpload();
                    showPage('home');
                }, 3000);
                return;
            }

            missingInfo.innerHTML = `
                <div class="info-box">
                    <p><strong>Dataset Info:</strong></p>
                    <p>Rows: ${currentData.length} | Columns: ${Object.keys(currentData[0]).length}</p>
                    <p>Missing values detected: ${missingCount}</p>
                </div>
            `;

            // Show preview
            const previewDiv = document.getElementById('previewTable');
            const previewData = currentData.slice(0, 5);
            let tableHtml = '<table><thead><tr>';
            
            Object.keys(previewData[0]).forEach(key => {
                tableHtml += `<th>${key}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            previewData.forEach(row => {
                tableHtml += '<tr>';
                Object.values(row).forEach(val => {
                    const displayVal = (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) ? '<em style="color: #dc143c;">missing</em>' : val;
                    tableHtml += `<td>${displayVal}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            previewDiv.innerHTML = tableHtml;

            showStep('step-preview');
        }

        function selectMethod(method) {
            selectedMethod = method;
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.method-card').classList.add('selected');
            
            setTimeout(() => {
                showParametersForm(method);
                showStep('step-params');
            }, 300);
        }

        function showParametersForm(method) {
            const form = document.getElementById('paramsForm');
            let html = '';

            if (method === 'iscak') {
                html = `
                    <div class="info-box">
                        <p><strong>ISCA-k</strong> - Advanced imputation using mutual information and adaptive k-NN</p>
                    </div>
                    <div class="form-group">
                        <label>Minimum Friends (k):</label>
                        <input type="number" id="minFriends" value="3" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Maximum Friends (k):</label>
                        <input type="number" id="maxFriends" value="15" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>MI Neighbors:</label>
                        <input type="number" id="miNeighbors" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Maximum Cycles:</label>
                        <input type="number" id="maxCycles" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Categorical Threshold:</label>
                        <input type="number" id="categoricalThreshold" value="10" min="2" max="50">
                    </div>
                `;
            } else if (method === 'knn') {
                html = `
                    <div class="form-group">
                        <label>Selection Method:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="knnMethod" value="fixed" checked onchange="toggleKnnInputs()">
                                Fixed k
                            </label>
                            <label>
                                <input type="radio" name="knnMethod" value="cv" onchange="toggleKnnInputs()">
                                Cross Validation
                            </label>
                        </div>
                    </div>
                    <div id="knnFixedInput">
                        <div class="form-group">
                            <label>Number of Neighbors (k):</label>
                            <input type="number" id="kValue" value="5" min="1" max="50">
                        </div>
                    </div>
                    <div id="knnRangeInput" style="display: none;">
                        <div class="range-inputs">
                            <div class="form-group">
                                <label>Minimum k:</label>
                                <input type="number" id="kMin" value="3" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label>Maximum k:</label>
                                <input type="number" id="kMax" value="15" min="1" max="50">
                            </div>
                        </div>
                    </div>
                `;
            } else if (method === 'mice') {
                html = `
                    <div class="form-group">
                        <label>Maximum Iterations:</label>
                        <input type="number" id="maxIterations" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Random Seed:</label>
                        <input type="number" id="seed" value="42" min="0">
                    </div>
                `;
            } else if (method === 'missforest') {
                html = `
                    <div class="form-group">
                        <label>Maximum Iterations:</label>
                        <input type="number" id="maxIterations" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Number of Trees:</label>
                        <input type="number" id="numTrees" value="100" min="10" max="500">
                    </div>
                    <div class="form-group">
                        <label>Random Seed:</label>
                        <input type="number" id="seed" value="42" min="0">
                    </div>
                `;
            }

            form.innerHTML = html;
        }

        function toggleKnnInputs() {
            const method = document.querySelector('input[name="knnMethod"]:checked').value;
            document.getElementById('knnFixedInput').style.display = method === 'fixed' ? 'block' : 'none';
            document.getElementById('knnRangeInput').style.display = method === 'cv' ? 'block' : 'none';
        }

        function startImputation() {
            showStep('step-processing');
            
            if (selectedMethod === 'iscak') {
                // ISCA-k usa a API
                performISCAkImputation();
            } else {
                // Outros métodos usam processamento local
                performLocalImputation();
            }
        }

        async function performISCAkImputation() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            try {
                progressText.textContent = 'Connecting to ISCA-k API...';
                progressFill.style.width = '10%';
                progressFill.textContent = '10%';
                
                // Prepara os dados
                const csvString = Papa.unparse(currentData);
                
                const params = {
                    min_friends: parseInt(document.getElementById('minFriends')?.value || 3),
                    max_friends: parseInt(document.getElementById('maxFriends')?.value || 15),
                    mi_neighbors: parseInt(document.getElementById('miNeighbors')?.value || 3),
                    max_cycles: parseInt(document.getElementById('maxCycles')?.value || 3),
                    categorical_threshold: parseInt(document.getElementById('categoricalThreshold')?.value || 10)
                };
                
                progressText.textContent = 'Sending data to server...';
                progressFill.style.width = '20%';
                progressFill.textContent = '20%';
                
                // Chama a API
                const response = await fetch(`${API_URL}/impute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csv_data: csvString,
                        ...params
                    })
                });
                
                progressFill.style.width = '80%';
                progressFill.textContent = '80%';
                progressText.textContent = 'Processing imputation...';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API request failed');
                }
                
                const result = await response.json();
                
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'Complete!';
                
                // Parse resultado
                imputedData = Papa.parse(result.csv_data, { header: true, dynamicTyping: true }).data;
                
                // Mostra estatísticas
                const stats = result.stats || {};
                document.getElementById('completionInfo').innerHTML = `
                    <p>Method: <strong>ISCA-k</strong></p>
                    <p>Original missing values: <strong>${stats.initial_missing || missingCount}</strong></p>
                    <p>Final missing values: <strong>${stats.final_missing || 0}</strong></p>
                    <p>Execution time: <strong>${stats.execution_time?.toFixed(2) || 'N/A'}s</strong></p>
                    <p>Strategy: <strong>${stats.strategy || 'ISCA-k'}</strong></p>
                `;
                
                setTimeout(() => {
                    showStep('step-complete');
                }, 500);
                
            } catch (error) {
                console.error('ISCA-k imputation error:', error);
                progressText.innerHTML = `
                    <div class="error-box">
                        <strong>Error:</strong> ${error.message}
                        <br><br>
                        Please check:
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>API URL is correctly configured</li>
                            <li>API is running and accessible</li>
                            <li>Your internet connection</li>
                        </ul>
                    </div>
                `;
                progressFill.style.width = '0%';
                progressFill.textContent = '';
            }
        }

        function performLocalImputation() {
            // Simulate progress
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressFill.textContent = Math.round(progress) + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'Analyzing dataset structure...';
                } else if (progress < 60) {
                    progressText.textContent = 'Computing imputations...';
                } else {
                    progressText.textContent = 'Finalizing dataset...';
                }
            }, 300);

            // Perform actual imputation
            setTimeout(() => {
                performImputation();
                clearInterval(interval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'Complete!';
                
                setTimeout(() => {
                    showCompletionInfo();
                    showStep('step-complete');
                }, 500);
            }, 3000);
        }

        function performImputation() {
            imputedData = JSON.parse(JSON.stringify(currentData));
            
            if (selectedMethod === 'knn') {
                const knnMethod = document.querySelector('input[name="knnMethod"]:checked')?.value || 'fixed';
                let k;
                
                if (knnMethod === 'fixed') {
                    k = parseInt(document.getElementById('kValue')?.value || 5);
                } else {
                    const kMin = parseInt(document.getElementById('kMin')?.value || 3);
                    const kMax = parseInt(document.getElementById('kMax')?.value || 15);
                    k = Math.floor((kMin + kMax) / 2); // Simplified: using midpoint
                }
                
                imputedData = knnImputation(imputedData, k);
            } else if (selectedMethod === 'mice') {
                const maxIter = parseInt(document.getElementById('maxIterations')?.value || 10);
                const seed = parseInt(document.getElementById('seed')?.value || 42);
                imputedData = miceImputation(imputedData, maxIter, seed);
            } else if (selectedMethod === 'missforest') {
                const maxIter = parseInt(document.getElementById('maxIterations')?.value || 10);
                const numTrees = parseInt(document.getElementById('numTrees')?.value || 100);
                const seed = parseInt(document.getElementById('seed')?.value || 42);
                imputedData = missForestImputation(imputedData, maxIter, numTrees, seed);
            }
        }

        // Imputation Algorithms

        function knnImputation(data, k) {
            const result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            columns.forEach(col => {
                for (let i = 0; i < result.length; i++) {
                    const val = result[i][col];
                    if (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) {
                        // Find k nearest neighbors
                        const distances = [];
                        for (let j = 0; j < result.length; j++) {
                            if (i !== j && result[j][col] !== null && result[j][col] !== undefined && result[j][col] !== '') {
                                const dist = calculateDistance(result[i], result[j], columns, col);
                                distances.push({ index: j, distance: dist });
                            }
                        }
                        
                        distances.sort((a, b) => a.distance - b.distance);
                        const neighbors = distances.slice(0, Math.min(k, distances.length));
                        
                        if (neighbors.length > 0) {
                            const values = neighbors.map(n => result[n.index][col]);
                            result[i][col] = typeof values[0] === 'number' 
                                ? values.reduce((a, b) => a + b, 0) / values.length
                                : values[0]; // For categorical, take first neighbor
                        }
                    }
                }
            });
            
            return result;
        }

        function calculateDistance(row1, row2, columns, skipCol) {
            let dist = 0;
            let count = 0;
            columns.forEach(col => {
                if (col !== skipCol) {
                    const v1 = row1[col];
                    const v2 = row2[col];
                    if (v1 != null && v2 != null && v1 !== '' && v2 !== '') {
                        if (typeof v1 === 'number' && typeof v2 === 'number') {
                            dist += Math.pow(v1 - v2, 2);
                            count++;
                        }
                    }
                }
            });
            return count > 0 ? Math.sqrt(dist / count) : Infinity;
        }

        function miceImputation(data, maxIter, seed) {
            let result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            // Seeded random number generator
            let seedValue = seed;
            const random = () => {
                seedValue = (seedValue * 9301 + 49297) % 233280;
                return seedValue / 233280;
            };
            
            // Initialize missing values with column means/modes
            columns.forEach(col => {
                const values = result.map(row => row[col]).filter(v => v != null && v !== '' && !isNaN(v));
                if (values.length === 0) return;
                
                const isNumeric = values.every(v => typeof v === 'number');
                const impVal = isNumeric 
                    ? values.reduce((a, b) => a + b, 0) / values.length
                    : values[0]; // Simple mode for categorical
                
                result.forEach(row => {
                    if (row[col] == null || row[col] === '' || isNaN(row[col])) {
                        row[col] = impVal;
                    }
                });
            });
            
            // Iterative imputation
            for (let iter = 0; iter < maxIter; iter++) {
                columns.forEach(targetCol => {
                    const otherCols = columns.filter(c => c !== targetCol);

                    // Simple linear regression for each column
                    // Build list of indices with non-missing values for this column
                    const trainIndices = [];
                    for (let i = 0; i < result.length; i++) {
                        if (originalData[i] && originalData[i][targetCol] != null && originalData[i][targetCol] !== '') {
                            trainIndices.push(i);
                        }
                    }

                    if (trainIndices.length > 0) {
                        // Find indices with missing values for this column
                        const missingIndices = [];
                        for (let i = 0; i < result.length; i++) {
                            if (originalData[i] && (originalData[i][targetCol] == null || originalData[i][targetCol] === '')) {
                                missingIndices.push(i);
                            }
                        }

                        // Impute missing values
                        missingIndices.forEach(idx => {
                            // Predict based on similar complete cases
                            const randomTrainIdx = trainIndices[Math.floor(random() * trainIndices.length)];
                            result[idx][targetCol] = result[randomTrainIdx][targetCol];
                        });
                    }
                });
            }
            
            return result;
        }

        function missForestImputation(data, maxIter, numTrees, seed) {
            let result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            // Seeded random
            let seedValue = seed;
            const random = () => {
                seedValue = (seedValue * 9301 + 49297) % 233280;
                return seedValue / 233280;
            };
            
            // Initialize with column means
            columns.forEach(col => {
                const values = result.map(row => row[col]).filter(v => v != null && v !== '' && !isNaN(v));
                if (values.length === 0) return;
                
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                result.forEach(row => {
                    if (row[col] == null || row[col] === '' || isNaN(row[col])) {
                        row[col] = mean;
                    }
                });
            });
            
            // Random Forest imputation (simplified)
            for (let iter = 0; iter < maxIter; iter++) {
                columns.forEach(targetCol => {
                    const completeRows = [];
                    const missingRows = [];
                    
                    result.forEach((row, idx) => {
                        if (originalData[idx]) {
                            const origVal = originalData[idx][targetCol];
                            if (origVal != null && origVal !== '' && !isNaN(origVal)) {
                                completeRows.push(row);
                            } else {
                                missingRows.push(row);
                            }
                        }
                    });
                    
                    if (completeRows.length > 0 && missingRows.length > 0) {
                        // Simplified: use ensemble of random samples
                        missingRows.forEach(row => {
                            let predictions = [];
                            for (let t = 0; t < Math.min(numTrees, 50); t++) {
                                const sample = completeRows[Math.floor(random() * completeRows.length)];
                                predictions.push(sample[targetCol]);
                            }
                            row[targetCol] = predictions.reduce((a, b) => a + b, 0) / predictions.length;
                        });
                    }
                });
            }
            
            return result;
        }

        function showCompletionInfo() {
            const info = document.getElementById('completionInfo');
            info.innerHTML = `
                <p>Method: <strong>${selectedMethod.toUpperCase()}</strong></p>
                <p>Original missing values: <strong>${missingCount}</strong></p>
                <p>Dataset is now complete and ready for download.</p>
            `;
        }

        function downloadImputedData() {
            const csv = Papa.unparse(imputedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const newFileName = fileName.replace('.csv', '_imputed.csv');
            link.setAttribute('href', url);
            link.setAttribute('download', newFileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetUpload() {
            document.getElementById('fileInput').value = '';
            currentData = null;
            originalData = null;
            fileName = '';
            missingCount = 0;
            showStep('step-upload');
        }

        function resetImputation() {
            document.getElementById('fileInput').value = '';
            currentData = null;
            originalData = null;
            fileName = '';
            selectedMethod = '';
            missingCount = 0;
            imputedData = null;
            showStep('step-upload');
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Feedback Form Validation and Submission
        document.addEventListener('DOMContentLoaded', function() {
            const feedbackForm = document.getElementById('feedbackForm');

            if (feedbackForm) {
                feedbackForm.addEventListener('submit', function(e) {
                    // Validate that at least one method is selected
                    const methodCheckboxes = feedbackForm.querySelectorAll('input[name^="method_"]');
                    const isAnyMethodChecked = Array.from(methodCheckboxes).some(cb => cb.checked);

                    if (!isAnyMethodChecked) {
                        e.preventDefault();
                        alert('Please select at least one imputation method that you used.');
                        return false;
                    }

                    // Show success message after a short delay (form will redirect to FormSubmit)
                    // Note: FormSubmit will redirect to their confirmation page
                });
            }
        });

        // ========================================
        // TEST METHODS PAGE - JAVASCRIPT
        // ========================================

        // Global variables for Test Methods
        let testConfig = {
            dataset: null,
            datasetName: '',
            datasetType: 'numeric',
            selectedMethods: [],
            missingRate: null,
            originalData: null,
            methodParams: {}
        };

        // Navigation functions
        function goToTestStep(stepNumber) {
            document.querySelectorAll('.test-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`test-step-${stepNumber}`).classList.add('active');
        }

        function selectDatasetType(type) {
            testConfig.datasetType = type;
            document.querySelectorAll('[onclick*="selectDatasetType"]').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');
        }

        async function selectDataset(name) {
            document.querySelectorAll('[data-dataset]').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');

            testConfig.datasetName = name;

            // Load dataset from JSON
            try {
                const response = await fetch(`datasets/${name}.json`);
                const data = await response.json();
                testConfig.dataset = data;
                testConfig.originalData = JSON.parse(JSON.stringify(data.data));
            } catch (error) {
                alert(`Error loading dataset: ${error.message}`);
            }
        }

        function toggleMethod(method) {
            const card = event.target.closest('.selection-card');
            const index = testConfig.selectedMethods.indexOf(method);

            if (index > -1) {
                testConfig.selectedMethods.splice(index, 1);
                card.classList.remove('selected');
            } else {
                if (testConfig.selectedMethods.length >= 3) {
                    alert('Maximum 3 methods allowed');
                    return;
                }
                testConfig.selectedMethods.push(method);
                card.classList.add('selected');
            }

            // Enable/disable continue button
            const btn = document.getElementById('btn-step-2');
            btn.disabled = testConfig.selectedMethods.length < 2;
        }

        function selectMissingRate(rate) {
            document.querySelectorAll('[data-rate]').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.selection-card').classList.add('selected');

            testConfig.missingRate = rate / 100;

            // Show parameters form
            showParametersForm();
        }

        function showParametersForm() {
            const container = document.getElementById('params-container');
            let html = '<h3 style="color: #ffffff; margin-bottom: 15px;">Method Parameters</h3>';

            testConfig.selectedMethods.forEach(method => {
                if (method === 'iscak') {
                    html += `
                        <div class="form-section">
                            <label>ISCA-k Parameters</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Minimum Friends (k):</label>
                                    <input type="number" id="iscak-min" value="3" min="1" max="50">
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Maximum Friends (k):</label>
                                    <input type="number" id="iscak-max" value="15" min="1" max="50">
                                </div>
                            </div>
                        </div>
                    `;
                } else if (method === 'knn') {
                    html += `
                        <div class="form-section">
                            <label>k-NN Parameters</label>
                            <label style="font-size: 14px; color: rgba(255,255,255,0.9); margin-bottom: 10px; display: block;">Selection Method:</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="knnMethod" value="fixed" checked onchange="toggleKnnInputsTest()">
                                    Fixed k
                                </label>
                                <label>
                                    <input type="radio" name="knnMethod" value="cv" onchange="toggleKnnInputsTest()">
                                    Cross Validation
                                </label>
                            </div>
                            <div id="knnFixedInputTest" style="margin-top: 15px;">
                                <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Number of Neighbors (k):</label>
                                <input type="number" id="knn-k" value="5" min="1" max="50" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                            </div>
                            <div id="knnRangeInputTest" style="display: none; margin-top: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Minimum k:</label>
                                        <input type="number" id="knn-k-min" value="3" min="1" max="50" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                                    </div>
                                    <div>
                                        <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Maximum k:</label>
                                        <input type="number" id="knn-k-max" value="15" min="1" max="50" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (method === 'mice') {
                    html += `
                        <div class="form-section">
                            <label>MICE Parameters</label>
                            <label style="font-size: 13px; color: rgba(255,255,255,0.8); margin-top: 10px; display: block;">Maximum Iterations:</label>
                            <input type="number" id="mice-iter" value="10" min="1" max="50" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                        </div>
                    `;
                } else if (method === 'missforest') {
                    html += `
                        <div class="form-section">
                            <label>MissForest Parameters</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                <div>
                                    <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Maximum Iterations:</label>
                                    <input type="number" id="missforest-iter" value="10" min="1" max="50" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                                </div>
                                <div>
                                    <label style="font-size: 13px; color: rgba(255,255,255,0.8);">Number of Trees:</label>
                                    <input type="number" id="missforest-trees" value="100" min="10" max="500" style="width: 100%; padding: 10px; border: 2px solid rgba(255, 107, 74, 0.3); border-radius: 5px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-family: 'Exo', sans-serif;">
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;

            // Enable start button
            document.getElementById('btn-step-3').disabled = false;
        }

        function toggleKnnInputsTest() {
            const method = document.querySelector('input[name="knnMethod"]:checked').value;
            document.getElementById('knnFixedInputTest').style.display = method === 'fixed' ? 'block' : 'none';
            document.getElementById('knnRangeInputTest').style.display = method === 'cv' ? 'block' : 'none';
        }

        // MCAR - Missing Completely At Random
        function introduceMCAR(data, missingRate, seed = 42) {
            const result = JSON.parse(JSON.stringify(data));
            const totalCells = result.length * result[0].length;
            const numMissing = Math.floor(totalCells * missingRate);

            // Seeded random number generator
            let seedValue = seed;
            const random = () => {
                seedValue = (seedValue * 9301 + 49297) % 233280;
                return seedValue / 233280;
            };

            // Randomly select cells to make missing
            const missingPositions = new Set();
            while (missingPositions.size < numMissing) {
                const row = Math.floor(random() * result.length);
                const col = Math.floor(random() * result[0].length);
                missingPositions.add(`${row},${col}`);
            }

            // Apply missings
            missingPositions.forEach(pos => {
                const [row, col] = pos.split(',').map(Number);
                result[row][col] = null;
            });

            return result;
        }

        // Metrics calculation functions
        function calculateR2(original, imputed) {
            const flatOriginal = original.flat().filter(v => v !== null && !isNaN(v));
            const flatImputed = imputed.flat().filter(v => v !== null && !isNaN(v));

            const mean = flatOriginal.reduce((a, b) => a + b, 0) / flatOriginal.length;
            const ssTot = flatOriginal.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);
            const ssRes = flatOriginal.reduce((sum, val, i) => sum + Math.pow(val - flatImputed[i], 2), 0);

            return 1 - (ssRes / ssTot);
        }

        function calculatePearson(original, imputed) {
            const flatOriginal = original.flat().filter(v => v !== null && !isNaN(v));
            const flatImputed = imputed.flat().filter(v => v !== null && !isNaN(v));

            const n = flatOriginal.length;
            const meanX = flatOriginal.reduce((a, b) => a + b, 0) / n;
            const meanY = flatImputed.reduce((a, b) => a + b, 0) / n;

            let num = 0, denX = 0, denY = 0;
            for (let i = 0; i < n; i++) {
                const dx = flatOriginal[i] - meanX;
                const dy = flatImputed[i] - meanY;
                num += dx * dy;
                denX += dx * dx;
                denY += dy * dy;
            }

            return num / Math.sqrt(denX * denY);
        }

        function calculateNRMSE(original, imputed) {
            const flatOriginal = original.flat().filter(v => v !== null && !isNaN(v));
            const flatImputed = imputed.flat().filter(v => v !== null && !isNaN(v));

            const n = flatOriginal.length;
            const mse = flatOriginal.reduce((sum, val, i) =>
                sum + Math.pow(val - flatImputed[i], 2), 0) / n;
            const rmse = Math.sqrt(mse);

            const range = Math.max(...flatOriginal) - Math.min(...flatOriginal);
            return rmse / range;
        }

        function calculateMAE(original, imputed) {
            const flatOriginal = original.flat().filter(v => v !== null && !isNaN(v));
            const flatImputed = imputed.flat().filter(v => v !== null && !isNaN(v));

            const n = flatOriginal.length;
            return flatOriginal.reduce((sum, val, i) =>
                sum + Math.abs(val - flatImputed[i]), 0) / n;
        }

        // Main test execution function
        async function startComparison() {
            goToTestStep(4);

            const progressFill = document.getElementById('test-progress-fill');
            const progressText = document.getElementById('test-progress-text');

            try {
                const results = {};
                const N_RUNS = 3;
                let totalSteps = testConfig.selectedMethods.length * N_RUNS;
                let currentStep = 0;

                // Run tests for each method
                for (const method of testConfig.selectedMethods) {
                    results[method] = {
                        r2: [],
                        pearson: [],
                        nrmse: [],
                        mae: [],
                        time: []
                    };

                    for (let run = 0; run < N_RUNS; run++) {
                        currentStep++;
                        const progress = (currentStep / totalSteps) * 100;
                        progressFill.style.width = progress + '%';
                        progressFill.textContent = Math.round(progress) + '%';
                        progressText.textContent = `Testing ${method.toUpperCase()} - Run ${run + 1}/${N_RUNS}...`;

                        // Introduce MCAR with different seed for each run
                        const dataMissing = introduceMCAR(testConfig.originalData, testConfig.missingRate, 42 + run);

                        // Convert to object format for imputation functions
                        const columnNames = testConfig.dataset.column_names;
                        const dataObj = dataMissing.map(row => {
                            const obj = {};
                            row.forEach((val, idx) => {
                                obj[columnNames[idx]] = val;
                            });
                            return obj;
                        });

                        // Store original for MICE/MissForest (they need it as global reference)
                        // They need the ORIGINAL data WITHOUT missings to know which rows to train on
                        const originalDataBackup = window.originalData;

                        // Convert original array data (without missings) to object format
                        const originalDataObj = testConfig.originalData.map(row => {
                            const obj = {};
                            row.forEach((val, idx) => {
                                obj[columnNames[idx]] = val;
                            });
                            return obj;
                        });
                        window.originalData = originalDataObj;

                        // Perform imputation
                        const startTime = performance.now();
                        let imputedData;

                        if (method === 'iscak') {
                            imputedData = await imputeISCAk(dataObj);
                        } else if (method === 'knn') {
                            const knnMethod = document.querySelector('input[name="knnMethod"]:checked')?.value || 'fixed';
                            let k;

                            if (knnMethod === 'fixed') {
                                k = parseInt(document.getElementById('knn-k')?.value || 5);
                            } else {
                                const kMin = parseInt(document.getElementById('knn-k-min')?.value || 3);
                                const kMax = parseInt(document.getElementById('knn-k-max')?.value || 15);
                                k = Math.floor((kMin + kMax) / 2); // Simplified: using midpoint
                            }

                            imputedData = knnImputation(dataObj, k);
                        } else if (method === 'mice') {
                            const maxIter = parseInt(document.getElementById('mice-iter')?.value || 10);
                            imputedData = miceImputation(dataObj, maxIter, 42 + run);
                        } else if (method === 'missforest') {
                            const maxIter = parseInt(document.getElementById('missforest-iter')?.value || 10);
                            const numTrees = parseInt(document.getElementById('missforest-trees')?.value || 100);
                            imputedData = missForestImputation(dataObj, maxIter, numTrees, 42 + run);
                        }

                        // Restore original
                        window.originalData = originalDataBackup;

                        const endTime = performance.now();
                        const executionTime = (endTime - startTime) / 1000;

                        // Convert back to array format
                        const imputedArray = imputedData.map(row => columnNames.map(col => row[col]));

                        // Calculate metrics
                        results[method].r2.push(calculateR2(testConfig.originalData, imputedArray));
                        results[method].pearson.push(calculatePearson(testConfig.originalData, imputedArray));
                        results[method].nrmse.push(calculateNRMSE(testConfig.originalData, imputedArray));
                        results[method].mae.push(calculateMAE(testConfig.originalData, imputedArray));
                        results[method].time.push(executionTime);

                        // Small delay to show progress
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                // Calculate averages
                const avgResults = {};
                for (const method of testConfig.selectedMethods) {
                    avgResults[method] = {
                        r2: results[method].r2.reduce((a, b) => a + b, 0) / N_RUNS,
                        pearson: results[method].pearson.reduce((a, b) => a + b, 0) / N_RUNS,
                        nrmse: results[method].nrmse.reduce((a, b) => a + b, 0) / N_RUNS,
                        mae: results[method].mae.reduce((a, b) => a + b, 0) / N_RUNS,
                        time: results[method].time.reduce((a, b) => a + b, 0) / N_RUNS
                    };
                }

                // Display results
                displayResults(avgResults);
                goToTestStep(5);

            } catch (error) {
                console.error('Test error:', error);
                progressText.innerHTML = `
                    <div class="error-box">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function imputeISCAk(data) {
            const csvString = Papa.unparse(data);
            const minFriends = parseInt(document.getElementById('iscak-min')?.value || 3);
            const maxFriends = parseInt(document.getElementById('iscak-max')?.value || 15);

            const response = await fetch(`${API_URL}/impute`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    csv_data: csvString,
                    min_friends: minFriends,
                    max_friends: maxFriends,
                    mi_neighbors: 3,
                    max_cycles: 3,
                    categorical_threshold: 10
                })
            });

            if (!response.ok) {
                throw new Error('ISCA-k API request failed');
            }

            const result = await response.json();
            return Papa.parse(result.csv_data, { header: true, dynamicTyping: true }).data;
        }

        function displayResults(results) {
            // Summary
            document.getElementById('test-summary').innerHTML = `
                <p><strong>Dataset:</strong> ${testConfig.datasetName.toUpperCase()}</p>
                <p><strong>Missing Rate:</strong> ${(testConfig.missingRate * 100)}%</p>
                <p><strong>Pattern:</strong> MCAR (Missing Completely At Random)</p>
                <p><strong>Methods Compared:</strong> ${testConfig.selectedMethods.map(m => m.toUpperCase()).join(', ')}</p>
                <p><strong>Runs:</strong> 3 (averaged)</p>
            `;

            // Results table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>R²</th>
                            <th>Pearson</th>
                            <th>NRMSE</th>
                            <th>MAE</th>
                            <th>Time (s)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Find best NRMSE (lowest)
            let bestNRMSE = Infinity;
            let bestMethod = '';
            for (const method of testConfig.selectedMethods) {
                if (results[method].nrmse < bestNRMSE) {
                    bestNRMSE = results[method].nrmse;
                    bestMethod = method;
                }
            }

            for (const method of testConfig.selectedMethods) {
                const r = results[method];
                const isBest = method === bestMethod ? ' class="best-result"' : '';
                tableHTML += `
                    <tr${isBest}>
                        <td><strong>${method.toUpperCase()}</strong></td>
                        <td>${r.r2.toFixed(3)}</td>
                        <td>${r.pearson.toFixed(3)}</td>
                        <td>${r.nrmse.toFixed(4)}</td>
                        <td>${r.mae.toFixed(4)}</td>
                        <td>${r.time.toFixed(2)}</td>
                    </tr>
                `;
            }

            tableHTML += '</tbody></table>';
            document.getElementById('results-table-container').innerHTML = tableHTML;

            // Draw NRMSE chart
            drawNRMSEChart(results);
        }

        function drawNRMSEChart(results) {
            const canvas = document.getElementById('nrmse-chart');
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const methods = testConfig.selectedMethods;
            const nrmseValues = methods.map(m => results[m].nrmse);

            // Chart settings
            const padding = 60;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            const barWidth = chartWidth / methods.length - 20;
            const maxValue = Math.max(...nrmseValues) * 1.2;

            // Draw axes
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Draw bars
            const colors = {
                'iscak': '#2E86AB',
                'knn': '#A23B72',
                'mice': '#F18F01',
                'missforest': '#C73E1D'
            };

            methods.forEach((method, i) => {
                const barHeight = (nrmseValues[i] / maxValue) * chartHeight;
                const x = padding + (i * (chartWidth / methods.length)) + 20;
                const y = canvas.height - padding - barHeight;

                // Draw bar
                ctx.fillStyle = colors[method] || '#ff6b4a';
                ctx.fillRect(x, y, barWidth, barHeight);

                // Draw value on top
                ctx.fillStyle = '#ffffff';
                ctx.font = '14px Exo';
                ctx.textAlign = 'center';
                ctx.fillText(nrmseValues[i].toFixed(4), x + barWidth / 2, y - 5);

                // Draw label
                ctx.fillText(method.toUpperCase(), x + barWidth / 2, canvas.height - padding + 25);
            });

            // Y-axis label
            ctx.save();
            ctx.translate(20, canvas.height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px Exo';
            ctx.textAlign = 'center';
            ctx.fillText('NRMSE', 0, 0);
            ctx.restore();

            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 18px Exo';
            ctx.textAlign = 'center';
            ctx.fillText('NRMSE Comparison (Lower is Better)', canvas.width / 2, 30);
        }

        function resetTestMethods() {
            testConfig = {
                dataset: null,
                datasetName: '',
                datasetType: 'numeric',
                selectedMethods: [],
                missingRate: null,
                originalData: null,
                methodParams: {}
            };

            document.querySelectorAll('.selection-card').forEach(card => {
                card.classList.remove('selected');
            });

            goToTestStep(1);
        }
    </script>
</body>
</html>
