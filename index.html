<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISCA-k - Imputation Algorithm</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #011136;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Background image 
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxyYWRpYWxHcmFkaWVudCBpZD0iZzEiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjUzMzMiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjxyYWRpYWxHcmFkaWVudCBpZD0iZzIiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiNmZjhkMzMiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjxyYWRpYWxHcmFkaWVudCBpZD0iZzMiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMzMzc3ODgiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMxYTFmMmUiLz48L3JhZGlhbEdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTkyMCIgaGVpZ2h0PSIxMDgwIiBmaWxsPSIjMWExZjJlIi8+PC9zdmc+');
            background-size: cover;
            background-position: center;
            opacity: 0.8;
            z-index: 0;
            pointer-events: none;
        }*/

        .container {
            position: relative;
            z-index: 1;
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        nav {
            position: fixed;
            top: 30px;
            right: 50px;
            z-index: 1000;
            display: flex;
            gap: 0;
            align-items: center;
        }

        nav button {
            background: transparent;
            border: none;
            color: #ffffff;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s ease;
            position: relative;
            letter-spacing: 0.5px;
        }

        nav button::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
        }

        nav button:first-child::before {
            display: none;
        }

        nav button:hover {
            color: #ff6b4a;
        }

        nav button.active {
            color: #ff6b4a;
            font-weight: 500;
        }

        /* Pages */
        .page {
            display: none;
            min-height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            position: relative;
        }

        /* Home Page */
        #home {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            min-height: 100vh;
            padding-bottom: 15vh;
            padding-left: 80px;
        }

        .home-content {
            text-align: left;
        }

        .logo {
            font-size: 96px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: -2px;
        }

        .logo-black {
            color: #ffffff;
        }

        .logo-red {
            color: #ff6b4a;
        }

        .subtitle {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300;
            letter-spacing: 0.5px;
            max-width: 600px;
        }

        /* About Page */
        #about {
            padding-top: 120px;
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .about-content h1 {
            margin-bottom: 20px;
            color: #ffffff;
        }

        .about-content p {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        /* Privacy Page */
        #privacy {
            padding-top: 120px;
        }

        .privacy-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: left;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .privacy-content h1 {
            margin-bottom: 20px;
            color: #ffffff;
        }

        .privacy-content p {
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
        }

        #privacy.page {
            margin-top: 30px; /* ou o valor que quiseres */
        }

        /* Imputation Page */
        #imputation {
            padding-top: 120px;
            padding-bottom: 50px;
        }

        .imputation-content {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(30, 36, 51, 0.9);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 107, 74, 0.1);
        }

        .imputation-content h1 {
            margin-bottom: 30px;
            color: #ffffff;
            text-align: center;
        }

        .imputation-content h2 {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .upload-area {
            border: 3px dashed rgba(255, 107, 74, 0.4);
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            background: rgba(255, 107, 74, 0.05);
        }

        .upload-area:hover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.1);
        }

        .upload-area.dragover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.15);
        }

        .upload-area h3, .upload-area p {
            color: #ffffff;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: #ff6b4a;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            margin: 10px 5px;
            font-family: 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .btn:hover {
            background: #ff8566;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
        }

        table th, table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px;
            text-align: left;
            color: rgba(255, 255, 255, 0.9);
        }

        table th {
            background: rgba(255, 107, 74, 0.2);
            font-weight: 600;
            color: #ffffff;
        }

        table td em {
            color: #ff6b4a;
        }

        .method-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .method-card {
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 10px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 107, 74, 0.05);
        }

        .method-card:hover {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.15);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 107, 74, 0.3);
        }

        .method-card.selected {
            border-color: #ff6b4a;
            background: rgba(255, 107, 74, 0.2);
            box-shadow: 0 4px 12px rgba(255, 107, 74, 0.4);
        }

        .method-card h3 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        .method-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 107, 74, 0.3);
            border-radius: 5px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-family: 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ff6b4a;
            background: rgba(255, 255, 255, 0.08);
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .progress-container {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ff6b4a;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b4a, #ff8566);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .info-box {
            background: rgba(255, 107, 74, 0.1);
            border-left: 4px solid #ff6b4a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .info-box strong {
            color: #ffffff;
        }

        .warning-box {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .error-box {
            background: rgba(255, 82, 82, 0.1);
            border-left: 4px solid #ff5252;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .progress-container {
            text-align: center;
            padding: 40px 20px;
        }

        .progress-container h2 {
            color: #ffffff;
            margin-bottom: 20px;
        }

        .progress-container p {
            color: rgba(255, 255, 255, 0.8);
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
    </style>
</head>
<body>
    <nav>
        <button onclick="showPage('home')" class="nav-btn active" data-page="home">Home</button>
        <button onclick="showPage('about')" class="nav-btn" data-page="about">About</button>
        <button onclick="showPage('imputation')" class="nav-btn" data-page="imputation">Imputation</button>
        <button onclick="showPage('privacy')" class="nav-btn" data-page="privacy">Data Privacy</button>
    </nav>

    <div class="container">
        <!-- HOME PAGE -->
        <div id="home" class="page active">
            <div class="home-content">
                <div class="logo">
                    <span class="logo-black">ISCA-</span><span class="logo-red">k</span>
                </div>
                <div class="subtitle">
                    Imputation & Similarity-based Classification Algorithm - a beta test
                </div>
            </div>
        </div>

        <!-- ABOUT PAGE -->
        <div id="about" class="page">
            <div class="about-content">
                <h1>About ISCA-k</h1>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                <p>Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae vitae dicta sunt explicabo.</p>
                <p>Nemo enim ipsam voluptatem quia voluptas sit aspernatur aut odit aut fugit, sed quia consequuntur magni dolores eos qui ratione voluptatem sequi nesciunt.</p>
            </div>
        </div>

        <!-- IMPUTATION PAGE -->
        <div id="imputation" class="page">
            <div class="imputation-content">
                <h1>Dataset Imputation</h1>

                <!-- Step 1: Upload -->
                <div class="step active" id="step-upload">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <h3>📁 Upload your CSV dataset</h3>
                        <p>Click to select or drag and drop your file here</p>
                        <input type="file" id="fileInput" accept=".csv" onchange="handleFileUpload(event)">
                    </div>
                </div>

                <!-- Step 2: Preview -->
                <div class="step" id="step-preview">
                    <h2>Dataset Preview</h2>
                    <div id="missingInfo"></div>
                    <div id="previewTable"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="resetUpload()">Upload Different File</button>
                        <button class="btn" onclick="showStep('step-method')">Continue</button>
                    </div>
                </div>

                <!-- Step 3: Method Selection -->
                <div class="step" id="step-method">
                    <h2>Select Imputation Method</h2>
                    <div class="method-selection" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="method-card" onclick="selectMethod('iscak')">
                            <h3 style="color: #dc143c;">ISCA-k</h3>
                            <p>Information-theoretic Smart Collaborative Approach</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('knn')">
                            <h3>k-NN</h3>
                            <p>k-Nearest Neighbors imputation</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('mice')">
                            <h3>MICE</h3>
                            <p>Multiple Imputation by Chained Equations</p>
                        </div>
                        <div class="method-card" onclick="selectMethod('missforest')">
                            <h3>MissForest</h3>
                            <p>Random Forest-based imputation</p>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showStep('step-preview')">Back</button>
                    </div>
                </div>

                <!-- Step 4: Parameters -->
                <div class="step" id="step-params">
                    <h2>Configure Parameters</h2>
                    <div id="paramsForm"></div>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showStep('step-method')">Back</button>
                        <button class="btn" onclick="startImputation()">Start Imputation</button>
                    </div>
                </div>

                <!-- Step 5: Processing -->
                <div class="step" id="step-processing">
                    <div class="progress-container">
                        <h2>Processing...</h2>
                        <div class="spinner"></div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill">0%</div>
                        </div>
                        <p id="progressText">Initializing...</p>
                    </div>
                </div>

                <!-- Step 6: Complete -->
                <div class="step" id="step-complete">
                    <div class="progress-container">
                        <h2>✓ Imputation Complete!</h2>
                        <div class="info-box">
                            <p><strong>Dataset successfully imputed!</strong></p>
                            <p id="completionInfo"></p>
                        </div>
                        <button class="btn" onclick="downloadImputedData()">Download Imputed Dataset</button>
                        <button class="btn btn-secondary" onclick="resetImputation()">Start New Imputation</button>
                    </div>
                </div>
            </div>
        </div>

                <!-- PRIVACY PAGE -->
        <div id="privacy" class="page">
            <div class="privacy-content">
                <h1>Privacy & Data Protection</h1>
        
                <p><strong>LOCAL PROCESSING (k-NN, MICE, MissForest):</strong><br>
                - All processing occurs locally, directly in your browser<br>
                - Your data NEVER leaves your browser<br>
                - 100% client-side processing<br>
                - Zero data transmission to servers<br>
                - No storage, no tracking, no logs</p>
        
                <p><strong>CLOUD PROCESSING (ISCA-k):</strong><br>
                - Data temporarily sent to secure EU server (Render.com - Frankfurt)<br>
                - Processed in-memory only (never written to disk)<br>
                - Automatically deleted after response<br>
                - HTTPS encrypted transmission<br>
                - No permanent storage or data retention<br>
                - Technical logs are disabled, but minimal metadata (timestamps and file sizes only) may temporarily remain on the server during normal use<br>
                - We do NOT store, sell, or share your actual data</p>
        
                <p><strong>SECURITY:</strong><br>
                - HTTPS/TLS encryption<br>
                - No authentication = no user tracking<br>
                - No cookies, no analytics<br>
                - Open-source code (audit on GitHub)</p>
        
                <p><strong>RECOMMENDATIONS:</strong><br>
                - Anonymize data before upload<br>
                - Do not upload personal identifiable information (PII)</p>
            </div>
        </div>

    </div>

    <script>
        let currentData = null;
        let originalData = null;
        let fileName = '';
        let selectedMethod = '';
        let missingCount = 0;
        let imputedData = null;
        
        // API URL - ALTERAR DEPOIS DO DEPLOY NO RENDER
        const API_URL = 'https://iscak-backend.onrender.com'; 

        // Navigation
        function showPage(pageName) {
            // Fade out current page
            const currentPage = document.querySelector('.page.active, .page-pri.active');
            if (currentPage) {
                currentPage.style.opacity = '0';
                setTimeout(() => {
                    currentPage.classList.remove('active');
                    
                    // Fade in new page
                    const newPage = document.getElementById(pageName);
                    newPage.classList.add('active');
                    setTimeout(() => {
                        newPage.style.opacity = '1';
                    }, 50);
                }, 300);
            } else {
                document.getElementById(pageName).classList.add('active');
            }
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
            
            // Reset imputation page when navigating to it
            if (pageName === 'imputation') {
                resetImputation();
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById(stepId).classList.add('active');
        }

        // File Upload
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                handleFile(file);
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            fileName = file.name;
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    originalData = results.data;
                    currentData = JSON.parse(JSON.stringify(results.data));
                    analyzeAndShowPreview();
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function analyzeAndShowPreview() {
            // Count missing values
            missingCount = 0;
            currentData.forEach(row => {
                Object.values(row).forEach(val => {
                    if (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) {
                        missingCount++;
                    }
                });
            });

            const missingInfo = document.getElementById('missingInfo');
            
            if (missingCount === 0) {
                missingInfo.innerHTML = `
                    <div class="warning-box">
                        <p><strong>No missing values detected!</strong></p>
                        <p>Your dataset appears to be complete. Imputation is not necessary.</p>
                    </div>
                `;
                setTimeout(() => {
                    resetUpload();
                    showPage('home');
                }, 3000);
                return;
            }

            missingInfo.innerHTML = `
                <div class="info-box">
                    <p><strong>Dataset Info:</strong></p>
                    <p>Rows: ${currentData.length} | Columns: ${Object.keys(currentData[0]).length}</p>
                    <p>Missing values detected: ${missingCount}</p>
                </div>
            `;

            // Show preview
            const previewDiv = document.getElementById('previewTable');
            const previewData = currentData.slice(0, 5);
            let tableHtml = '<table><thead><tr>';
            
            Object.keys(previewData[0]).forEach(key => {
                tableHtml += `<th>${key}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';

            previewData.forEach(row => {
                tableHtml += '<tr>';
                Object.values(row).forEach(val => {
                    const displayVal = (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) ? '<em style="color: #dc143c;">missing</em>' : val;
                    tableHtml += `<td>${displayVal}</td>`;
                });
                tableHtml += '</tr>';
            });

            tableHtml += '</tbody></table>';
            previewDiv.innerHTML = tableHtml;

            showStep('step-preview');
        }

        function selectMethod(method) {
            selectedMethod = method;
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.method-card').classList.add('selected');
            
            setTimeout(() => {
                showParametersForm(method);
                showStep('step-params');
            }, 300);
        }

        function showParametersForm(method) {
            const form = document.getElementById('paramsForm');
            let html = '';

            if (method === 'iscak') {
                html = `
                    <div class="info-box">
                        <p><strong>ISCA-k</strong> - Advanced imputation using mutual information and adaptive k-NN</p>
                    </div>
                    <div class="form-group">
                        <label>Minimum Friends (k):</label>
                        <input type="number" id="minFriends" value="3" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>Maximum Friends (k):</label>
                        <input type="number" id="maxFriends" value="15" min="1" max="50">
                    </div>
                    <div class="form-group">
                        <label>MI Neighbors:</label>
                        <input type="number" id="miNeighbors" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Maximum Cycles:</label>
                        <input type="number" id="maxCycles" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label>Categorical Threshold:</label>
                        <input type="number" id="categoricalThreshold" value="10" min="2" max="50">
                    </div>
                `;
            } else if (method === 'knn') {
                html = `
                    <div class="form-group">
                        <label>Selection Method:</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="knnMethod" value="fixed" checked onchange="toggleKnnInputs()">
                                Fixed k
                            </label>
                            <label>
                                <input type="radio" name="knnMethod" value="cv" onchange="toggleKnnInputs()">
                                Cross Validation
                            </label>
                        </div>
                    </div>
                    <div id="knnFixedInput">
                        <div class="form-group">
                            <label>Number of Neighbors (k):</label>
                            <input type="number" id="kValue" value="5" min="1" max="50">
                        </div>
                    </div>
                    <div id="knnRangeInput" style="display: none;">
                        <div class="range-inputs">
                            <div class="form-group">
                                <label>Minimum k:</label>
                                <input type="number" id="kMin" value="3" min="1" max="50">
                            </div>
                            <div class="form-group">
                                <label>Maximum k:</label>
                                <input type="number" id="kMax" value="15" min="1" max="50">
                            </div>
                        </div>
                    </div>
                `;
            } else if (method === 'mice') {
                html = `
                    <div class="form-group">
                        <label>Maximum Iterations:</label>
                        <input type="number" id="maxIterations" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Random Seed:</label>
                        <input type="number" id="seed" value="42" min="0">
                    </div>
                `;
            } else if (method === 'missforest') {
                html = `
                    <div class="form-group">
                        <label>Maximum Iterations:</label>
                        <input type="number" id="maxIterations" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Number of Trees:</label>
                        <input type="number" id="numTrees" value="100" min="10" max="500">
                    </div>
                    <div class="form-group">
                        <label>Random Seed:</label>
                        <input type="number" id="seed" value="42" min="0">
                    </div>
                `;
            }

            form.innerHTML = html;
        }

        function toggleKnnInputs() {
            const method = document.querySelector('input[name="knnMethod"]:checked').value;
            document.getElementById('knnFixedInput').style.display = method === 'fixed' ? 'block' : 'none';
            document.getElementById('knnRangeInput').style.display = method === 'cv' ? 'block' : 'none';
        }

        function startImputation() {
            showStep('step-processing');
            
            if (selectedMethod === 'iscak') {
                // ISCA-k usa a API
                performISCAkImputation();
            } else {
                // Outros métodos usam processamento local
                performLocalImputation();
            }
        }

        async function performISCAkImputation() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            try {
                progressText.textContent = 'Connecting to ISCA-k API...';
                progressFill.style.width = '10%';
                progressFill.textContent = '10%';
                
                // Prepara os dados
                const csvString = Papa.unparse(currentData);
                
                const params = {
                    min_friends: parseInt(document.getElementById('minFriends')?.value || 3),
                    max_friends: parseInt(document.getElementById('maxFriends')?.value || 15),
                    mi_neighbors: parseInt(document.getElementById('miNeighbors')?.value || 3),
                    max_cycles: parseInt(document.getElementById('maxCycles')?.value || 3),
                    categorical_threshold: parseInt(document.getElementById('categoricalThreshold')?.value || 10)
                };
                
                progressText.textContent = 'Sending data to server...';
                progressFill.style.width = '20%';
                progressFill.textContent = '20%';
                
                // Chama a API
                const response = await fetch(`${API_URL}/impute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csv_data: csvString,
                        ...params
                    })
                });
                
                progressFill.style.width = '80%';
                progressFill.textContent = '80%';
                progressText.textContent = 'Processing imputation...';
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'API request failed');
                }
                
                const result = await response.json();
                
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'Complete!';
                
                // Parse resultado
                imputedData = Papa.parse(result.csv_data, { header: true, dynamicTyping: true }).data;
                
                // Mostra estatísticas
                const stats = result.stats || {};
                document.getElementById('completionInfo').innerHTML = `
                    <p>Method: <strong>ISCA-k</strong></p>
                    <p>Original missing values: <strong>${stats.initial_missing || missingCount}</strong></p>
                    <p>Final missing values: <strong>${stats.final_missing || 0}</strong></p>
                    <p>Execution time: <strong>${stats.execution_time?.toFixed(2) || 'N/A'}s</strong></p>
                    <p>Strategy: <strong>${stats.strategy || 'ISCA-k'}</strong></p>
                `;
                
                setTimeout(() => {
                    showStep('step-complete');
                }, 500);
                
            } catch (error) {
                console.error('ISCA-k imputation error:', error);
                progressText.innerHTML = `
                    <div class="error-box">
                        <strong>Error:</strong> ${error.message}
                        <br><br>
                        Please check:
                        <ul style="text-align: left; margin-top: 10px;">
                            <li>API URL is correctly configured</li>
                            <li>API is running and accessible</li>
                            <li>Your internet connection</li>
                        </ul>
                    </div>
                `;
                progressFill.style.width = '0%';
                progressFill.textContent = '';
            }
        }

        function performLocalImputation() {
            // Simulate progress
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress >= 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressFill.textContent = Math.round(progress) + '%';
                
                if (progress < 30) {
                    progressText.textContent = 'Analyzing dataset structure...';
                } else if (progress < 60) {
                    progressText.textContent = 'Computing imputations...';
                } else {
                    progressText.textContent = 'Finalizing dataset...';
                }
            }, 300);

            // Perform actual imputation
            setTimeout(() => {
                performImputation();
                clearInterval(interval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                progressText.textContent = 'Complete!';
                
                setTimeout(() => {
                    showCompletionInfo();
                    showStep('step-complete');
                }, 500);
            }, 3000);
        }

        function performImputation() {
            imputedData = JSON.parse(JSON.stringify(currentData));
            
            if (selectedMethod === 'knn') {
                const knnMethod = document.querySelector('input[name="knnMethod"]:checked')?.value || 'fixed';
                let k;
                
                if (knnMethod === 'fixed') {
                    k = parseInt(document.getElementById('kValue')?.value || 5);
                } else {
                    const kMin = parseInt(document.getElementById('kMin')?.value || 3);
                    const kMax = parseInt(document.getElementById('kMax')?.value || 15);
                    k = Math.floor((kMin + kMax) / 2); // Simplified: using midpoint
                }
                
                imputedData = knnImputation(imputedData, k);
            } else if (selectedMethod === 'mice') {
                const maxIter = parseInt(document.getElementById('maxIterations')?.value || 10);
                const seed = parseInt(document.getElementById('seed')?.value || 42);
                imputedData = miceImputation(imputedData, maxIter, seed);
            } else if (selectedMethod === 'missforest') {
                const maxIter = parseInt(document.getElementById('maxIterations')?.value || 10);
                const numTrees = parseInt(document.getElementById('numTrees')?.value || 100);
                const seed = parseInt(document.getElementById('seed')?.value || 42);
                imputedData = missForestImputation(imputedData, maxIter, numTrees, seed);
            }
        }

        // Imputation Algorithms

        function knnImputation(data, k) {
            const result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            columns.forEach(col => {
                for (let i = 0; i < result.length; i++) {
                    const val = result[i][col];
                    if (val === null || val === undefined || val === '' || (typeof val === 'number' && isNaN(val))) {
                        // Find k nearest neighbors
                        const distances = [];
                        for (let j = 0; j < result.length; j++) {
                            if (i !== j && result[j][col] !== null && result[j][col] !== undefined && result[j][col] !== '') {
                                const dist = calculateDistance(result[i], result[j], columns, col);
                                distances.push({ index: j, distance: dist });
                            }
                        }
                        
                        distances.sort((a, b) => a.distance - b.distance);
                        const neighbors = distances.slice(0, Math.min(k, distances.length));
                        
                        if (neighbors.length > 0) {
                            const values = neighbors.map(n => result[n.index][col]);
                            result[i][col] = typeof values[0] === 'number' 
                                ? values.reduce((a, b) => a + b, 0) / values.length
                                : values[0]; // For categorical, take first neighbor
                        }
                    }
                }
            });
            
            return result;
        }

        function calculateDistance(row1, row2, columns, skipCol) {
            let dist = 0;
            let count = 0;
            columns.forEach(col => {
                if (col !== skipCol) {
                    const v1 = row1[col];
                    const v2 = row2[col];
                    if (v1 != null && v2 != null && v1 !== '' && v2 !== '') {
                        if (typeof v1 === 'number' && typeof v2 === 'number') {
                            dist += Math.pow(v1 - v2, 2);
                            count++;
                        }
                    }
                }
            });
            return count > 0 ? Math.sqrt(dist / count) : Infinity;
        }

        function miceImputation(data, maxIter, seed) {
            let result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            // Seeded random number generator
            let seedValue = seed;
            const random = () => {
                seedValue = (seedValue * 9301 + 49297) % 233280;
                return seedValue / 233280;
            };
            
            // Initialize missing values with column means/modes
            columns.forEach(col => {
                const values = result.map(row => row[col]).filter(v => v != null && v !== '' && !isNaN(v));
                if (values.length === 0) return;
                
                const isNumeric = values.every(v => typeof v === 'number');
                const impVal = isNumeric 
                    ? values.reduce((a, b) => a + b, 0) / values.length
                    : values[0]; // Simple mode for categorical
                
                result.forEach(row => {
                    if (row[col] == null || row[col] === '' || isNaN(row[col])) {
                        row[col] = impVal;
                    }
                });
            });
            
            // Iterative imputation
            for (let iter = 0; iter < maxIter; iter++) {
                columns.forEach(targetCol => {
                    const otherCols = columns.filter(c => c !== targetCol);
                    
                    // Simple linear regression for each column
                    const trainData = result.filter(row => 
                        originalData[result.indexOf(row)][targetCol] != null &&
                        originalData[result.indexOf(row)][targetCol] !== ''
                    );
                    
                    if (trainData.length > 0) {
                        const missingRows = result.filter(row => {
                            const origRow = originalData[result.indexOf(row)];
                            return origRow[targetCol] == null || origRow[targetCol] === '';
                        });
                        
                        missingRows.forEach(row => {
                            // Predict based on similar complete cases
                            let prediction = trainData[Math.floor(random() * trainData.length)][targetCol];
                            row[targetCol] = prediction;
                        });
                    }
                });
            }
            
            return result;
        }

        function missForestImputation(data, maxIter, numTrees, seed) {
            let result = JSON.parse(JSON.stringify(data));
            const columns = Object.keys(data[0]);
            
            // Seeded random
            let seedValue = seed;
            const random = () => {
                seedValue = (seedValue * 9301 + 49297) % 233280;
                return seedValue / 233280;
            };
            
            // Initialize with column means
            columns.forEach(col => {
                const values = result.map(row => row[col]).filter(v => v != null && v !== '' && !isNaN(v));
                if (values.length === 0) return;
                
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                result.forEach(row => {
                    if (row[col] == null || row[col] === '' || isNaN(row[col])) {
                        row[col] = mean;
                    }
                });
            });
            
            // Random Forest imputation (simplified)
            for (let iter = 0; iter < maxIter; iter++) {
                columns.forEach(targetCol => {
                    const completeRows = [];
                    const missingRows = [];
                    
                    result.forEach((row, idx) => {
                        const origVal = originalData[idx][targetCol];
                        if (origVal != null && origVal !== '' && !isNaN(origVal)) {
                            completeRows.push(row);
                        } else {
                            missingRows.push(row);
                        }
                    });
                    
                    if (completeRows.length > 0 && missingRows.length > 0) {
                        // Simplified: use ensemble of random samples
                        missingRows.forEach(row => {
                            let predictions = [];
                            for (let t = 0; t < Math.min(numTrees, 50); t++) {
                                const sample = completeRows[Math.floor(random() * completeRows.length)];
                                predictions.push(sample[targetCol]);
                            }
                            row[targetCol] = predictions.reduce((a, b) => a + b, 0) / predictions.length;
                        });
                    }
                });
            }
            
            return result;
        }

        function showCompletionInfo() {
            const info = document.getElementById('completionInfo');
            info.innerHTML = `
                <p>Method: <strong>${selectedMethod.toUpperCase()}</strong></p>
                <p>Original missing values: <strong>${missingCount}</strong></p>
                <p>Dataset is now complete and ready for download.</p>
            `;
        }

        function downloadImputedData() {
            const csv = Papa.unparse(imputedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const newFileName = fileName.replace('.csv', '_imputed.csv');
            link.setAttribute('href', url);
            link.setAttribute('download', newFileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function resetUpload() {
            document.getElementById('fileInput').value = '';
            currentData = null;
            originalData = null;
            fileName = '';
            missingCount = 0;
            showStep('step-upload');
        }

        function resetImputation() {
            document.getElementById('fileInput').value = '';
            currentData = null;
            originalData = null;
            fileName = '';
            selectedMethod = '';
            missingCount = 0;
            imputedData = null;
            showStep('step-upload');
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
    </script>
</body>
</html>
